<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Luxmax - 장바구니" />
    <title>장바구니 - Luxmax</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/favicon.png" />
    <link rel="manifest" href="/manifest.json" />

    <!-- CSS -->
    <link rel="preload" href="css/styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="css/styles.css" rel="stylesheet"></noscript>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css" media="print" onload="this.media='all'">

    <!-- Scripts -->
    <script src="js/saas.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.all.min.js" defer></script>
    
    <!-- Amplitude SDK -->
    <script src="https://cdn.amplitude.com/libs/analytics-browser-2.10.0-min.js.gz" defer></script>
    <script src="https://cdn.amplitude.com/libs/session-replay-browser-1.20.1-min.js.gz" defer></script>
    
    <!-- Amplitude 플러그인 -->
    <script src="https://cdn.amplitude.com/script/cf4c439c94d3b0d118d74737fc630588.experiment.js" defer></script>
    <script src="https://cdn.amplitude.com/script/cf4c439c94d3b0d118d74737fc630588.engagement.js" defer></script>
    
    <!-- Amplitude 초기화 -->
    <script defer>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof amplitude !== 'undefined') {
                amplitude.init('YOUR_AMPLITUDE_API_KEY', {});
                if (typeof window.engagement !== 'undefined') {
                    amplitude.add(window.engagement.plugin());
                }
            }
        });
    </script>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-white" id="navbarCommon">
            <!-- 네비게이션은 main.js에서 로드됨 -->
        </nav>
    </header>

    <!-- Cart Section -->
    <section class="py-5" style="margin-top: 100px;">
        <div class="container">
            <h2 class="mb-4"><i class="bi bi-cart3 me-2"></i>장바구니</h2>
            
            <div id="cartContainer">
                <!-- 장바구니 아이템이 여기에 동적으로 로드됨 -->
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">로딩 중...</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-5 bg-dark mt-5">
        <div class="container">
            <p class="m-0 text-center text-white">Copyright &copy; Luxmax</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="js/scripts.js" defer></script>
    <script src="js/main.js" defer></script>
    
    <script defer>
        document.addEventListener('DOMContentLoaded', function() {
            // URL 파라미터에서 상품 ID 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            const quantity = parseInt(urlParams.get('quantity')) || 1;
            
            // URL에서 직접 추가된 경우
            if (productId) {
                if (typeof addCartItem === 'function') {
                    addCartItem(productId, quantity);
                } else {
                    let cartItems = JSON.parse(localStorage.getItem('lm.storage.item.cartItems') || '[]');
                    const existingItem = cartItems.find(item => item.id === productId);
                    
                    if (existingItem) {
                        existingItem.quantity += quantity;
                    } else {
                        cartItems.push({ id: productId, quantity: quantity });
                    }
                    
                    localStorage.setItem('lm.storage.item.cartItems', JSON.stringify(cartItems));
                }
                
                // URL 정리
                window.history.replaceState({}, document.title, 'cart.html');
            }
            
            // 장바구니 로드
            loadCart();
            
            function loadCart() {
                // main.js의 로직 사용 (cart 페이지 체크)
                // main.js에서 이미 처리하므로 여기서는 대체 로직만 제공
                
                const cartItems = JSON.parse(localStorage.getItem('lm.storage.item.cartItems') || '[]');
                
                if (cartItems.length === 0) {
                    displayEmptyCart();
                    return;
                }
                
                // 상품 정보 가져오기
                const items = JSON.parse(localStorage.getItem('lm.storage.item.items') || '[]');
                
                let totalPrice = 0;
                let cartHTML = '<div class="row"><div class="col-md-8">';
                
                cartItems.forEach(cartItem => {
                    const product = items.find(item => item.id === cartItem.id);
                    if (!product) return;
                    
                    const itemTotal = (product.price || 0) * cartItem.quantity;
                    totalPrice += itemTotal;
                    
                    cartHTML += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        <img src="${product.image || 'https://via.placeholder.com/100'}" 
                                             class="img-fluid rounded" 
                                             alt="${product.name}">
                                    </div>
                                    <div class="col-md-4">
                                        <h5>${product.name}</h5>
                                        <p class="text-muted mb-0">${formatPrice(product.price)}</p>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="input-group">
                                            <button class="btn btn-outline-secondary" onclick="updateQuantity('${cartItem.id}', -1)">-</button>
                                            <input type="number" class="form-control text-center" 
                                                   value="${cartItem.quantity}" 
                                                   min="1" 
                                                   id="qty-${cartItem.id}">
                                            <button class="btn btn-outline-secondary" onclick="updateQuantity('${cartItem.id}', 1)">+</button>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <h5>${formatPrice(itemTotal)}</h5>
                                    </div>
                                    <div class="col-md-1">
                                        <button class="btn btn-danger btn-sm" onclick="removeFromCart('${cartItem.id}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                cartHTML += '</div><div class="col-md-4">';
                cartHTML += `
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">주문 요약</h5>
                            <hr>
                            <div class="d-flex justify-content-between mb-2">
                                <span>상품 합계</span>
                                <span>${formatPrice(totalPrice)}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>배송비</span>
                                <span>${totalPrice >= 50000 ? '무료' : formatPrice(3000)}</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <h5>총 결제금액</h5>
                                <h5 class="text-primary">${formatPrice(totalPrice + (totalPrice >= 50000 ? 0 : 3000))}</h5>
                            </div>
                            <button class="btn btn-primary btn-lg w-100" onclick="checkout()">
                                <i class="bi bi-bag-check me-2"></i>주문하기
                            </button>
                            <a href="index.html" class="btn btn-outline-secondary w-100 mt-2">
                                <i class="bi bi-arrow-left me-2"></i>쇼핑 계속하기
                            </a>
                        </div>
                    </div>
                `;
                cartHTML += '</div></div>';
                
                document.getElementById('cartContainer').innerHTML = cartHTML;
            }
            
            function displayEmptyCart() {
                document.getElementById('cartContainer').innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-cart-x" style="font-size: 5rem; color: #ccc;"></i>
                        <h3 class="mt-3">장바구니가 비어있습니다</h3>
                        <p class="text-muted">상품을 추가해보세요!</p>
                        <a href="index.html" class="btn btn-primary btn-lg">
                            <i class="bi bi-arrow-left me-2"></i>쇼핑하러 가기
                        </a>
                    </div>
                `;
            }
            
            function formatPrice(price) {
                if (!price) return '₩0';
                return new Intl.NumberFormat('ko-KR', {
                    style: 'currency',
                    currency: 'KRW'
                }).format(price);
            }
            
            // 전역 함수
            window.updateQuantity = function(productId, change) {
                let cartItems = JSON.parse(localStorage.getItem('lm.storage.item.cartItems') || '[]');
                const item = cartItems.find(item => item.id === productId);
                
                if (item) {
                    item.quantity = Math.max(1, item.quantity + change);
                    if (item.quantity <= 0) {
                        removeFromCart(productId);
                        return;
                    }
                    localStorage.setItem('lm.storage.item.cartItems', JSON.stringify(cartItems));
                    loadCart();
                }
            };
            
            window.removeFromCart = function(productId) {
                if (typeof removeCartItemById === 'function') {
                    removeCartItemById(productId);
                } else {
                    let cartItems = JSON.parse(localStorage.getItem('lm.storage.item.cartItems') || '[]');
                    cartItems = cartItems.filter(item => item.id !== productId);
                    localStorage.setItem('lm.storage.item.cartItems', JSON.stringify(cartItems));
                }
                loadCart();
            };
            
            window.checkout = function() {
                const cartItems = JSON.parse(localStorage.getItem('lm.storage.item.cartItems') || '[]');
                
                if (cartItems.length === 0) {
                    Swal.fire('오류', '장바구니가 비어있습니다.', 'error');
                    return;
                }
                
                // main.js의 purchaseRequest 함수 사용
                if (typeof purchaseRequest === 'function') {
                    const ids = cartItems.map(item => item.id).join(',');
                    window.location.search = `?id=${ids}`;
                    // purchaseRequest는 main.js에서 URL 파라미터를 읽어서 처리함
                } else {
                    Swal.fire({
                        title: '주문 확인',
                        text: '주문을 진행하시겠습니까?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: '주문하기',
                        cancelButtonText: '취소'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Swal.fire('주문 완료', '주문이 완료되었습니다!', 'success').then(() => {
                                localStorage.removeItem('lm.storage.item.cartItems');
                                window.location.href = 'index.html';
                            });
                        }
                    });
                }
            };
        });
    </script>
</body>
</html>
